<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" href="images/favicon.avif" />
    <title>L&G promotores</title>

    <style>
      body {
        font-family: Arial;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #f7f7f7;
      }
      h2 {
        margin-top: 40px;
      }
      .item {
        padding: 10px;
        background: white;
        margin: 10px 0;
        border-radius: 5px;
        cursor: pointer;
        border: 1px solid #ccc;
      }
      .item:hover {
        background: #e7e7e7;
      }

      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0 15px 0;
      }
      button {
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .btn-red {
        background: #d9534f;
      }
      .btn-red:hover {
        background: #b52b27;
      }

      /* CONTENEDOR DE IM츼GENES */
      #imagenesTerreno img {
        width: 160px;
        border-radius: 5px;
        margin: 5px;
        border: 1px solid #aaa;
        cursor: zoom-in;
      }

      #imagenesTerreno {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 15px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
    </style>
  </head>

  <body>
    <h1>Editor de archivo JSON - Terrenos</h1>

    <h2>1. Cargar archivo JSON</h2>
    <input type="file" id="fileInput" accept=".json" />

    <h2>2. Lista de Terrenos</h2>
    <div id="lista"></div>

    <button
      onclick="nuevoTerreno()"
      style="margin-top: 10px; background: #28a745"
    >
      + Agregar nuevo terreno
    </button>

    <h2>3. Editar / Agregar Terreno</h2>
    <form id="formulario" style="display: none">
      <label>T칤tulo</label>
      <input type="text" id="titulo" />

      <label>Medida</label>
      <input type="text" id="medida" />

      <label>Detalle</label>
      <textarea id="detalle" rows="5"></textarea>

      <label>Precio</label>
      <textarea id="precio" rows="5"></textarea>

      <label>Ubicaci칩n (URL)</label>
      <input type="text" id="ubicacion" />

      <button type="button" onclick="guardarCambios()">Guardar cambios</button>
    </form>

    <h2>4. Im치genes del terreno seleccionado</h2>
    <div id="imagenesTerreno"></div>

    <h2>5. Descargar JSON actualizado</h2>
    <button onclick="descargarJSON()">Descargar JSON</button>

    <script>
      let data = [];
      let indiceActual = null;

      /* --------------------------
          Cargar archivo JSON manual
      --------------------------- */
      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          const reader = new FileReader();
          reader.onload = function () {
            data = JSON.parse(reader.result);
            mostrarLista();
          };
          reader.readAsText(e.target.files[0]);
        });

      /* --------------------------
          Mostrar lista
      --------------------------- */
      function mostrarLista() {
        const cont = document.getElementById("lista");
        cont.innerHTML = "";

        data.forEach((item, i) => {
          let div = document.createElement("div");
          div.classList.add("item");
          div.textContent = item.titulo;
          div.onclick = () => editar(i);
          cont.appendChild(div);
        });
      }

      /* --------------------------
          Extraer coordenadas
      --------------------------- */
      function extraerCoordenadas(url) {
        if (!url) return null;

        const regexDecimal = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
        const m = url.match(regexDecimal);

        if (m) {
          return {
            lat: m[1].replace("-", "").replace(".", "-"),
            lon: m[2].replace("-", "").replace(".", "-"),
          };
        }
        return null;
      }

      /* --------------------------
          Cargar im치genes del terreno
      --------------------------- */
      async function cargarImagenesTerreno(item) {
        const cont = document.getElementById("imagenesTerreno");
        cont.innerHTML = "<p>Cargando im치genes...</p>";

        const coords = extraerCoordenadas(item.ubicacion);
        if (!coords) {
          cont.innerHTML = "<p>No hay coordenadas v치lidas.</p>";
          return;
        }

        const basePath = `terrenos/${coords.lat}/`;

        let imagenes = [];
        try {
          const indexData = await fetch(`${basePath}index.json`).then((r) =>
            r.json()
          );

          for (let i = 1; i <= indexData.cantidad; i++) {
            imagenes.push(`${basePath}${i}.avif`);
          }
        } catch (e) {
          cont.innerHTML = "<p>No se encontraron im치genes.</p>";
          return;
        }

        cont.innerHTML = imagenes
          .map(
            (img) =>
              `<img src="${img}" onclick="this.style.width='600px'" title="Click para ampliar">`
          )
          .join("");
      }

      /* --------------------------
          Editar terreno
      --------------------------- */
      function editar(i) {
        indiceActual = i;

        const item = data[i];
        document.getElementById("titulo").value = item.titulo;
        document.getElementById("medida").value = item.medida;
        document.getElementById("detalle").value = item.detalle;
        document.getElementById("precio").value = item.precio;
        document.getElementById("ubicacion").value = item.ubicacion;

        document.getElementById("formulario").style.display = "block";

        // 游댠 Cargar im치genes del terreno seleccionado
        cargarImagenesTerreno(item);
      }

      /* --------------------------
          Nuevo terreno
      --------------------------- */
      function nuevoTerreno() {
        indiceActual = null;

        document.getElementById("titulo").value = "";
        document.getElementById("medida").value = "";
        document.getElementById("detalle").value = "";
        document.getElementById("precio").value = "";
        document.getElementById("ubicacion").value = "";

        document.getElementById("formulario").style.display = "block";

        document.getElementById("imagenesTerreno").innerHTML = "";
      }

      /* --------------------------
          Guardar cambios
      --------------------------- */
      function guardarCambios() {
        const nuevo = {
          titulo: document.getElementById("titulo").value,
          medida: document.getElementById("medida").value,
          detalle: document.getElementById("detalle").value,
          precio: document.getElementById("precio").value,
          ubicacion: limpiarUbicacion(
            document.getElementById("ubicacion").value
          ),
        };

        if (indiceActual === null) {
          data.push(nuevo);
          alert("Terreno agregado correctamente");
        } else {
          data[indiceActual] = nuevo;
          alert("Cambios guardados");
        }

        mostrarLista();
      }

      function limpiarUbicacion(url) {
        return url.replace(/"S/g, "''S").replace(/"W/g, "''W");
      }

      /* --------------------------
          Descargar JSON
      --------------------------- */
      function descargarJSON() {
        const blob = new Blob([JSON.stringify(data, null, 4)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "terrenos_modificado.json";
        a.click();
      }

      /* --------------------------
          Cargar JSON autom치ticamente
      --------------------------- */
      async function cargarTerrenos() {
        let local = "data/terrenos.json";
        let remoto =
          "https://taylorbundy.github.io/Terreno_Web/data/terrenos.json";

        try {
          let r = await fetch(local);
          if (!r.ok) throw "No local";
          data = await r.json();
        } catch {
          console.warn("Cargando desde GitHub...");
          const r = await fetch(remoto);
          data = await r.json();
        }

        mostrarLista();
      }

      document.addEventListener("DOMContentLoaded", cargarTerrenos);
    </script>
  </body>
</html>
